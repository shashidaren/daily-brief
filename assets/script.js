async function getJSON(url){const res=await fetch(url+(url.includes('?')?'&':'?')+'cb='+Date.now());if(!res.ok)throw new Error('Failed to load '+url);return res.json();}
function formatTime(iso){const d=new Date(iso);return d.toLocaleString(undefined,{hour12:false});}
function applyFilters(items){const q=document.getElementById('search').value.trim().toLowerCase();const cat=document.getElementById('category').value;return items.filter(i=>{const matchCat=(cat==='all')||(i.category===cat);const matchQ=!q||(i.title.toLowerCase().includes(q)||(i.summary||'').toLowerCase().includes(q)||i.source.toLowerCase().includes(q));return matchCat&&matchQ;});}
function renderCards(containerId,list){const el=document.getElementById(containerId);el.innerHTML='';list.forEach(item=>{const card=document.createElement('article');card.className='card';card.innerHTML=`<a href="${item.link}" target="_blank" rel="noopener"><h2>${item.title}</h2></a><div class="meta"><span>${item.source}</span><span>·</span><span>${new URL(item.link).hostname.replace('www.','')}</span><span>·</span><span>${formatTime(item.published)}</span><span>·</span><span>${item.category}</span></div>${item.summary?`<div class="summary">${item.summary}</div>`:''}`;el.appendChild(card);});}
function renderTicker(items){const track=document.getElementById('tickerTrack');if(!track)return;if(!items.length){track.textContent='No market data.';return;}const row=items.map(it=>{const ch=Number(it.change||0),pct=Number(it.percent||0);const cls=ch>=0?'chg-pos':'chg-neg';const sign=ch>=0?'+':'';return `<span class="item"><span class="sym">${it.ticker}</span><span>${Number(it.price).toLocaleString(undefined,{maximumFractionDigits:2})}</span><span class="${cls}">${sign}${ch.toFixed(2)} (${sign}${pct.toFixed(2)}%)</span></span>`;}).join('');track.innerHTML=row+row;}
(async function boot(){try{const news=await getJSON('news/news.json');document.getElementById('updatedAt').textContent='Updated: '+formatTime(news.generatedAt);const items=news.items||[];const renderNow=()=>renderCards('feed',applyFilters(items));document.getElementById('search').addEventListener('input',renderNow);document.getElementById('category').addEventListener('change',renderNow);document.getElementById('refresh').addEventListener('click',()=>location.reload());renderNow();const techAI=items.filter(i=>i.category==='tech'||i.category==='ai').slice(0,6);renderCards('techHighlights',techAI);const evDeals=items.filter(i=>i.category==='events'||i.category==='deals'||i.category==='gadgets').slice(0,6);renderCards('eventsDeals',evDeals);}catch(e){document.getElementById('feed').innerHTML='<div class="card">Failed to load news. '+e.message+'</div>';}try{const markets=await getJSON('markets/markets.json');renderTicker(markets.items||[]);}catch(e){const track=document.getElementById('tickerTrack');if(track)track.textContent='Run Fetch Markets workflow to populate ticker.';}})();